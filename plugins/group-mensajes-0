import fs from 'fs'

const dbPath = './database/msg-count.json'

var handler = async (m, { conn, args, isAdmin, groupMetadata }) => {
  if (!m.isGroup) return
  if (!isAdmin) return conn.reply(m.chat, 'âŒ Solo administradores.', m)

  if (!fs.existsSync(dbPath))
    return conn.reply(m.chat, 'âŒ No hay datos.', m)

  let data = JSON.parse(fs.readFileSync(dbPath))
  let chatData = data[m.chat] || {}

  let participants = groupMetadata.participants.map(p => p.id)

  let filter = args[0] !== undefined ? Number(args[0]) : null
  if (args[0] !== undefined && isNaN(filter))
    return conn.reply(m.chat, 'âŒ Usa un nÃºmero vÃ¡lido.\nEj: *.mensajes 0*', m)

  let text = filter === null
    ? `ğŸ“Š *MENSAJES DEL GRUPO*\n\n`
    : `ğŸ“Š *PARTICIPANTES CON ${filter} MENSAJES*\n\n`

  let mentions = []
  let countShow = 0

  for (let jid of participants) {
    let count = chatData[jid] || 0

    if (filter === null || count === filter) {
      mentions.push(jid)
      text += `â€¢ @${jid.split('@')[0]} â€” *${count}*\n`
      countShow++
    }
  }

  if (!countShow)
    return conn.reply(
      m.chat,
      `âŒ Nadie tiene *${filter}* mensajes.`,
      m
    )

  await conn.reply(m.chat, text, m, { mentions })
}

handler.help = ['mensajes [numero]']
handler.tags = ['grupo']
handler.command = ['mensajes', 'msg']
handler.group = true
handler.admin = true

export default handler